apt update

# installer k3s
curl -sfL https://get.k3s.io | sh -


# récupérer la config kube du server local
mkdir -p ~/.kube
cp /etc/rancher/k3s/k3s.yaml ~/.kube/config

# installer docker si non présent
if ! command -v docker &> /dev/null; then
    curl -fsSL https://get.docker.com -o get-docker.sh
    sh get-docker.sh
    rm get-docker.sh
    echo "Docker installé."
fi

# démarrer une registry locale pour le dev
docker run -d -p 5000:5000 --restart=always --name registry registry:2 || true

# installer skaffold
curl -Lo skaffold https://storage.googleapis.com/skaffold/releases/latest/skaffold-linux-amd64
sudo install skaffold /usr/local/bin/
rm skaffold

# cloner le frontend client
git clone https://iut-git.unice.fr/simon/simon

# cloner les dépôts IOT
mkdir iot
cd iot
git clone https://iut-git.unice.fr/simon/iot/capteur
git clone https://iut-git.unice.fr/simon/iot/passerelle

# cloner les API
cd ..
mkdir APIs
cd APIs
git clone https://iut-git.unice.fr/simon/services/api-capteur
git clone https://iut-git.unice.fr/simon/services/api-ingestion
git clone https://iut-git.unice.fr/simon/services/serviceauthent