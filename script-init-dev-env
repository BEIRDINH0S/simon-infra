#!/bin/bash

# Vérifier que le script n'est pas lancé en root
if [ "$EUID" -eq 0 ]; then
   echo "ERREUR: Ce script ne doit PAS être lancé en root ou avec sudo"
   echo "Lancez-le en tant qu'utilisateur normal"
   exit 1
fi

echo "======================================"
echo "Installation de l'environnement de développement Simon"
echo "======================================"
echo ""

sudo apt update

echo "Installation de Docker Engine dans WSL2..."

# Vérifier si Docker Engine est déjà installé localement dans WSL
if [ -f /usr/bin/dockerd ]; then
    echo "Docker Engine déjà installé."

    # Vérifier si Docker tourne
    if ! docker ps &> /dev/null; then
        echo "Démarrage de Docker Engine..."
        sudo service docker start
        sleep 3

        if ! docker ps &> /dev/null; then
            echo "ERREUR: Impossible de démarrer Docker."
            echo "Vérifiez que vous êtes dans le groupe docker avec: groups"
            echo "Si 'docker' n'apparaît pas, déconnectez-vous et reconnectez-vous."
            exit 1
        fi
    fi
    echo "Docker Engine fonctionne correctement."
else
    echo "Installation de Docker Engine dans WSL2..."

    # Nettoyage des anciennes installations
    sudo apt-get remove -y docker docker-engine docker.io containerd runc 2>/dev/null || true

    # Installation via le script officiel Docker
    curl -fsSL https://get.docker.com -o get-docker.sh
    sudo sh get-docker.sh
    rm get-docker.sh
    echo "Docker Engine installé."

    # Ajouter l'utilisateur actuel au groupe docker
    sudo usermod -aG docker $USER
    echo "Vous avez été ajouté au groupe docker."

    # Démarrer le service Docker
    sudo service docker start

    # Vérifier que Docker démarre correctement
    echo "Vérification du démarrage de Docker..."
    sleep 3
    if ! sudo docker ps &> /dev/null; then
        echo "ERREUR: Docker ne démarre pas correctement."
        echo "Vérifiez les logs avec: sudo journalctl -u docker"
        exit 1
    fi

    echo ""
    echo "======================================"
    echo "IMPORTANT: Configuration des permissions"
    echo "======================================"
    echo "Vous devez vous DÉCONNECTER et RECONNECTER à votre session WSL"
    echo "pour que les changements de groupe docker prennent effet."
    echo ""
    echo "Pour vous déconnecter de WSL, dans PowerShell/CMD Windows:"
    echo "  wsl --shutdown"
    echo "Puis rouvrez WSL et réexécutez:"
    echo "  ./infra/script-init-dev-env"
    echo ""
    exit 0
fi

# S'assurer qu'on utilise bien le socket Docker local et pas celui de Docker Desktop
export DOCKER_HOST=unix:///var/run/docker.sock

# Vérifier qu'on utilise bien Docker Engine local
DOCKER_INFO=$(docker info 2>/dev/null | grep "Operating System" || echo "")
if [[ "$DOCKER_INFO" == *"Docker Desktop"* ]]; then
    echo "ATTENTION: Le contexte Docker pointe vers Docker Desktop."
    echo "Pour utiliser Docker Engine dans WSL2, désactivez l'intégration WSL2 dans Docker Desktop:"
    echo "  Settings > Resources > WSL Integration > Décochez votre distribution"
    echo "Puis redémarrez WSL avec: wsl --shutdown (dans PowerShell Windows)"
    exit 1
fi

echo "Docker Engine local (WSL2) utilisé correctement."

# configurer docker pour le registry local
mkdir -p ~/.docker
cat > ~/.docker/config.json << 'EOF'
{
  "auths": {
    "localhost:5000": {}
  }
}
EOF
echo "Configuration Docker créée pour le registry local"

# installer minikube
curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
sudo install minikube-linux-amd64 /usr/local/bin/minikube
rm minikube-linux-amd64

# démarrer minikube avec docker driver et profil dev
# Configuration optimisée pour WSL2 + Docker Engine
echo "Démarrage de minikube (cela peut prendre quelques minutes)..."

# S'assurer que minikube utilise Docker Engine local
export DOCKER_HOST=unix:///var/run/docker.sock

minikube start -p dev \
  --driver=docker \
  --container-runtime=docker \
  --cpus=2 \
  --memory=3072 \
  --wait=all \
  --wait-timeout=10m

echo "Minikube démarré avec Docker Engine local."

# installer kubectl
curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
rm kubectl

# mettre à jour le contexte kubectl pour le cluster dev
minikube update-context -p dev

# activer le registry addon de minikube sur le cluster dev
minikube addons enable registry -p dev

# configurer le port forwarding pour accéder à la registry depuis l'hôte
kubectl port-forward --namespace kube-system service/registry 5000:80 > /dev/null 2>&1 &

# installer skaffold
curl -Lo skaffold https://storage.googleapis.com/skaffold/releases/latest/skaffold-linux-amd64
sudo install skaffold /usr/local/bin/
rm skaffold

# cloner le frontend client
git clone https://iut-git.unice.fr/simon/simon

# cloner les API
mkdir -p APIs
cd APIs
git clone https://iut-git.unice.fr/simon/services/api-capteur
git clone https://iut-git.unice.fr/simon/services/api-ingestion
git clone https://iut-git.unice.fr/simon/services/api-auth-user
git clone https://iut-git.unice.fr/simon/services/api-gateway-client

echo ""
echo "======================================"
echo "Installation terminée avec succès !"
echo "======================================"
echo ""
echo "Pour démarrer l'environnement de développement :"
echo "  cd simon/infra/dev"
echo "  skaffold dev"
echo ""
echo "Services qui seront accessibles :"
echo "  - Frontend:        http://localhost:8080"
echo "  - API Capteur:     http://localhost:3000"
echo "  - API Ingestion:   http://localhost:3001"
echo "  - API Auth User:   http://localhost:3002"
echo "  - API Gateway:     http://localhost:3003"
echo "  - PostgreSQL:      localhost:5432"
echo ""
echo "Commandes utiles :"
echo "  minikube profile dev    # Activer le profil dev"
echo "  kubectl get pods        # Voir les pods"
echo "  minikube dashboard      # Interface web Kubernetes"
echo ""
