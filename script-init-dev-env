apt update

# installer docker si non présent
if ! command -v docker &> /dev/null; then
    curl -fsSL https://get.docker.com -o get-docker.sh
    sh get-docker.sh
    rm get-docker.sh
    echo "Docker installé."
fi

# installer minikube
curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
sudo install minikube-linux-amd64 /usr/local/bin/minikube
rm minikube-linux-amd64

# démarrer minikube avec docker driver
minikube start --driver=docker

# récupérer la config kube
mkdir -p ~/.kube
minikube kubectl -- config view --flatten > ~/.kube/config

# activer le registry addon de minikube
minikube addons enable registry

# configurer le port forwarding pour accéder à la registry depuis l'hôte
kubectl port-forward --namespace kube-system service/registry 5000:80 &

# installer skaffold
curl -Lo skaffold https://storage.googleapis.com/skaffold/releases/latest/skaffold-linux-amd64
sudo install skaffold /usr/local/bin/
rm skaffold

# cloner le frontend client
git clone https://iut-git.unice.fr/simon/simon

# cloner les dépôts IOT
mkdir iot
cd iot
git clone https://iut-git.unice.fr/simon/iot/capteur
git clone https://iut-git.unice.fr/simon/iot/passerelle

# cloner les API
cd ..
mkdir APIs
cd APIs
git clone https://iut-git.unice.fr/simon/services/api-capteur
git clone https://iut-git.unice.fr/simon/services/api-ingestion
git clone https://iut-git.unice.fr/simon/services/serviceauthent